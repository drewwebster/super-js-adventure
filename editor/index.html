<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Super JS Adventure!</title>
    
    <link rel="stylesheet" type="text/css" href="css/main.css">
</head>

<body>
    
    <main role="main">
        
        <div class="canvas-container">
            <div class="canvas"></div>
        </div>

        <div class="sidebar">
            <div class="layers"></div>
            <div class="tiles"></div>
        </div>
    </main>
    
    <script>
        // Helpers
        function _(elm) { return document.querySelector(elm); }

        (function() {
            function __(elm) {
                var elms    = document.querySelectorAll(elm),
                    nodes   = Array.prototype.slice.call(elms);

                this.css = function() {
                    if(arguments.length == 2) {
                        for (var i = 0; i < elms.length; i++) {
                            elms[i].style[arguments[0]] = arguments[1];
                        };
                    }
                    else if(typeof arguments == 'object') {
                        var obj = arguments[0];
                        for (var i = 0; i < elms.length; i++) {
                            for(var a in obj) {
                                elms[i].style[a] = obj[a];
                            } 
                        };
                    }
                }

                this.each = function(callback) {
                    for(var i = elms.length; i--;) {
                        callback.call(elms[i]);
                    }
                }

                return this;
            }
            
            window.__ = __;    
        })();
        
    </script>

    <script>
        var Editor = function() {
            'use strict';

            var _canvas         = _('.canvas'),
                overworld_tiles = new Array(),
                tileSize        = 8,
                scale           = 4,
                cols            = 32, // 256
                rows            = 28, // 224

                // Image scaling
                srcCanvas,
                dstCanvas,
                srcCtx,
                dstCtx,

                // Tile select
                selectedTile,
                elmClicked;

            var init = function() {
                srcCanvas   = document.createElement('canvas'),
                dstCanvas   = document.createElement('canvas'),
                srcCtx      = srcCanvas.getContext('2d'),
                dstCtx      = dstCanvas.getContext('2d');

                loadInterface();
                setupLevelArray();
                drawGrid();
                loadTiles();

                // events
                _('.tiles').addEventListener('click', selectTile);
                _canvas.addEventListener('click', placeTile);
            }

            var loadInterface = function() {
                // Size the ‘canvas’
                _canvas.style['width']  = (cols * tileSize * scale) + 'px';
                _canvas.style['height'] = (rows * tileSize * scale) + 'px';

                // Size the sidebar area
                _('.tiles').style['width'] = window.getComputedStyle( _('.sidebar') ).width;
            }

            var setupLevelArray = function() {
                for (var row = 0; row < rows; row++) {
                    overworld_tiles[row] = new Array();

                    for (var col = 0; col < cols; col++) {
                        overworld_tiles[row][col] = 0;
                    };
                };
            }

            var drawGrid = function() {
                var _grid       = document.createElement('canvas'),
                    gridCtx     = _grid.getContext('2d'),
                    width       = (cols * tileSize * scale),
                    height      = (rows * tileSize * scale);

                _grid.width    = width;
                _grid.height   = height;

                _grid.style['position'] = 'absolute';
                _grid.style['top']  = 0;
                _grid.style['left'] = 0;

                _canvas.appendChild(_grid);

                gridCtx.strokeStyle = '#333';
                gridCtx.lineWidth   = 1;

                for (var col = 1; col < cols; col++) {
                    gridCtx.beginPath();
                    gridCtx.moveTo( (col * tileSize * scale) - 0.5, 0 );
                    gridCtx.lineTo( (col * tileSize * scale) - 0.5, height );
                    gridCtx.stroke();
                };

                for (var row = 1; row < rows; row++) {
                    gridCtx.beginPath();
                    gridCtx.moveTo( 0, (row * tileSize * scale) - 0.5 );
                    gridCtx.lineTo( width, (row * tileSize * scale) - 0.5 );
                    gridCtx.stroke();
                };
            }

            var loadTiles = function() {
                var _tileContainer  = _('.tiles'),
                    tileCount       = 22,
                    tilesLoaded     = 0,
                    dir             = 'images/Zelda-Tiles-8x8/Overworld/',
                    ul              = document.createElement('ul');

                for (var i = 1; i < (tileCount+1); i++) {
                    var img         = new Image(),
                        fileName    = 'grass-dirt0' + (i < 10 ? '0'+i : i);

                    img.src = dir + fileName + '.png';

                    img.onload = function() {
                        var li          = document.createElement('li'),
                            textNode    = document.createTextNode( 'grass-dirt0' + (tilesLoaded < 10 ? '0'+(tilesLoaded+1) : (tilesLoaded+1)) ),
                            scaledImage = new Image();

                        scaledImage.src = scaleImage(this, 4);

                        li.appendChild(scaledImage);
                        li.appendChild(textNode);

                        ul.appendChild(li);
                        tilesLoaded++;

                        if(tileCount == tilesLoaded)
                            _tileContainer.appendChild(ul);
                    };
                };

            }

            var scaleImage = function(img, factor) {
                
                // set up source
                srcCanvas.width     = img.width;
                srcCanvas.height    = img.height;
                srcCtx.clearRect(0, 0, img.width, img.height);
                srcCtx.drawImage(img, 0, 0);
                
                var srcData = srcCtx.getImageData(0, 0, img.width, img.height).data;

                var sw = factor * img.width;
                var sh = factor * img.height;

                // set up destination
                dstCanvas.width     = sw;
                dstCanvas.height    = sh;
                dstCtx.clearRect(0, 0, sw, sh);

                var dstImgData  = dstCtx.getImageData(0,0,sw,sh);
                var dstData     = dstImgData.data;

                // factor
                var srcP = 0;
                var dstP = 0;

                for (var y = 0; y < img.height; ++y) {
                    for (var i = 0; i < factor; ++i) {
                        for (var x = 0; x < img.width; ++x) {
                            
                            var srcP = 4 * (y * img.width + x);
                            
                            for (var j = 0; j < factor; ++j) {
                                var tmp = srcP;
                                dstData[dstP++] = srcData[tmp++];
                                dstData[dstP++] = srcData[tmp++];
                                dstData[dstP++] = srcData[tmp++];
                                dstData[dstP++] = srcData[tmp++];
                            };
                        };
                    };
                };

                dstCtx.putImageData(dstImgData, 0, 0);

                return dstCanvas.toDataURL();
            }

            /*
                Render
            */
            var render = function() {
                // render the tiles
                for (var row = 0; row < overworld_tiles.length; row++) {
                    for (var col = 0; col < overworld_tiles[row].length; col++) {

                        /**
                            Try using canvas to slice the sprite and create a base64 encoded crop to use as a background for the div?
                            Still has the issue of aliasing the image though.
                            Use an image?
                        **/

                        // var elm = document.createElement('div');

                        // elm.style['background']      = 'url(images/overworld-sprite.png) -8px -8px no-repeat';
                        // elm.style['backgroundSize']  = '2000%';

                        // elm.style['width']  = (8 * scale) + 'px';
                        // elm.style['height'] = (8 * scale) + 'px';

                        // elm.style['top']    = row * (8 * scale) + 'px';
                        // elm.style['left']   = col * (8 * scale) + 'px';

                        /*
                            Image elements
                        */

                        // var elm = new Image();

                        // elm.style['top']    = row * (8 * scale) + 'px';
                        // elm.style['left']   = col * (8 * scale) + 'px';

                        // elm.src = scaleSlice(sprite, 4, 0, 0, 8, 8);

                        // $('.canvas').appendChild(elm);

                        // var offsetX         = 16,
                        //     offsetY         = 16,
                        //     source_width    = 8,
                        //     source_height   = 8;

                        // ctx.drawImage(sprite, offsetX, offsetY, source_width, source_height, row * (8 * scale), col * (8 * scale), 8 * scale, 8 * scale);
                    };
                };

                var elm = new Image();

                elm.style['top']    = row * (8 * scale) + 'px';
                elm.style['left']   = col * (8 * scale) + 'px';

                elm.src = scaleImage(sprite, 2);

                _canvas.appendChild(elm);
            }

            var pxToCell = function(x, y) {
                var width   = cols * tileSize * scale,
                    height  = rows * tileSize * scale;

                return {
                    col: Math.floor( (x / width) * cols ),
                    row: Math.floor( (y / height) * rows )
                }
            }

            var selectTile = function(e) {
                var le = document.querySelectorAll('.tiles li');

                for (var i = 0; i < le.length; i++) {
                    le[i].style['border'] = '';
                };

                if( elmClicked == null )
                    elmClicked = e.target;

                while( elmClicked.nodeName != 'LI' && elmClicked != e.currentTarget ) {
                    elmClicked = e.target.parentNode;
                };

                elmClicked.style['border']  = '1px solid green';
                selectedTile                = elmClicked;
                elmClicked                  = null;
            }

            var placeTile = function(e) {
                if( !selectedTile )
                    return;

                var tileElement = selectedTile.querySelector('img').cloneNode(true),
                    gridCell    = pxToCell( (e.clientX + _('.canvas-container').scrollLeft), (e.clientY + _('.canvas-container').scrollTop) );

                tileElement.style['position']   = 'absolute';
                tileElement.style['left']       = (gridCell.col * tileSize * scale) + 'px';
                tileElement.style['top']        = (gridCell.row * tileSize * scale) + 'px';

                console.log( e.clientX, e.clientY, gridCell, (gridCell.col * tileSize * scale), (gridCell.row * tileSize * scale));
                
                _canvas.appendChild(tileElement);
            }

            // Start!
            init();
        }


        // Begin!
        var editor = new Editor();
    </script>
</body>
</html>